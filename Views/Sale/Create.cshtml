@model E_Invoice_system.Models.Sale
@{
    Layout = "_SaleLayout";
    var customers = ViewBag.Customers as List<E_Invoice_system.Models.customers>;
    var products = ViewBag.Products as List<E_Invoice_system.Models.ProductService>;
}

<div class="pos-container-v2">
    <!-- Center: Product Discovery -->
    <div class="product-canvas">
        <div class="canvas-header">
            <div class="canvas-header-top">
                <h3 class="canvas-title">Sales Transaction</h3>

                <div class="search-bar-v2">
                    <i class="ph-magnifying-glass search-icon"></i>
                    <input type="text" id="prodSearch" class="search-input" placeholder="Scan or enter barcode..." oninput="filterProducts()">
                </div>
                
                <div class="mode-toggle-v2 compact">
                    <div class="toggle-pill">
                        <input type="radio" id="searchName" name="searchMode" value="name" onchange="handleSearchModeChange()">
                        <label for="searchName">Name</label>
                        <input type="radio" id="searchBarcode" name="searchMode" value="barcode" checked onchange="handleSearchModeChange()">
                        <label for="searchBarcode">Barcode</label>
                    </div>
                </div>

                <!-- Quick Actions Toolbar -->
                <div class="quick-actions-v2">
                    <button type="button" class="btn-action-round" onclick="reloadPage()" title="Refresh">
                        <i class="ph-arrows-clockwise"></i>
                    </button>
                    <button type="button" class="btn-action-round" onclick="toggleFullScreen()" title="Full Screen">
                        <i class="ph-corners-out"></i>
                    </button>
                    <a href="/Home/Index" class="btn-action-round back" title="Back to Dashboard">
                        <i class="ph-arrow-left"></i>
                    </a>
                </div>
            </div>

            <div class="category-tabs-v2">
                <div class="tab-item active" onclick="filterByCategory('all', this)">All</div>
                <div class="tab-item" onclick="filterByCategory('Foods', this)">Products</div>
                <div class="tab-item" onclick="filterByCategory('Beverages', this)">Services</div>
            </div>
        </div>


        <div class="product-grid-v2" id="productGrid">
            @if (products != null)

            {
                foreach (var p in products)
                {
                    decimal stockValue = 0;
                    string unitLabel = "";
                    bool isService = false;

                    if (!string.IsNullOrEmpty(p.qty_unit_type))
                    {
                        var match = System.Text.RegularExpressions.Regex.Match(p.qty_unit_type.Trim(), @"^([0-9.-]+)\s*(.*)$");
                        if (match.Success)
                        {
                            decimal.TryParse(match.Groups[1].Value, out stockValue);
                            unitLabel = match.Groups[2].Value.Trim();
                            if (!string.IsNullOrEmpty(unitLabel))
                            {
                                isService = true;
                                stockValue = 999999;
                            }
                        }
                        else
                        {
                            isService = true;
                            // Set high stock value for services so they can be added without restriction
                            stockValue = 999999; 
                        }
                    }
                    else 
                    {
                        // No qty_unit_type means unlimited/service
                        isService = true;
                        stockValue = 999999;
                    }

                    <div class="product-card-v2" 
                         data-id="@p.id"
                         data-name="@p.prod_name_service" 
                         data-search-name="@p.prod_name_service.ToLower()"
                         data-barcode="@(p.barcode?.ToLower() ?? "")" 
                         data-price="@p.price"
                         data-discount="@p.discount"
                         data-expiry="@(p.expiry_date?.ToString("yyyy-MM-dd") ?? "")"
                         data-stock="@stockValue" 
                         data-type="@(isService ? "service" : "product")"
                         data-image="@(p.image ?? "")"
                         onclick="addToSaleFromCard(this)">
                        
                        <div class="card-image">
                            @if (!string.IsNullOrEmpty(p.image))
                            {
                                <img src="/product-images/@p.image" alt="Product" />
                            }
                            else
                            {
                                <div class="image-placeholder">
                                    <i class="@(isService ? "ph-wrench" : "ph-cube-transparent")" style="font-size: 3rem; color: #cbd5e1;"></i>
                                </div>
                            }
                        </div>
                        <div class="card-info">
                            <h4 class="card-name">@p.prod_name_service</h4>
                            <div class="card-price-row">
                                <span class="price-tag">$@p.price.ToString("N2")</span>
                                @if (p.discount > 0)
                                {
                                    <span class="discount-pill">-$@p.discount.ToString("N2")</span>
                                }
                            </div>
                        </div>
                    </div>

                }
            }
        </div>
    </div>

    <!-- Right: Checkout Center -->
    <div class="checkout-center">
        <form asp-action="Create" method="post" id="saleForm" class="checkout-form">
            @Html.AntiForgeryToken()
            <input type="hidden" name="payment_method" id="hiddenPaymentMethod" value="Cash" />
            <input type="hidden" name="status" id="hiddenStatus" value="Paid" />
            
            <div class="checkout-header">
                <div class="checkout-header-main">
                    <div>
                        <h3 class="order-detail-title">Order Detail</h3>
                        <div id="itemCountDisplay" class="item-count-badge">0 items selected</div>
                    </div>
                    
                    <div class="checkout-header-actions">
                         <div class="mode-toggle-v2 compact">
                            <div class="toggle-pill">
                                <input type="radio" id="modeSale" name="transMode" value="sale" checked onchange="handleModeChange()">
                                <label for="modeSale">Sale</label>
                                <input type="radio" id="modeReturn" name="transMode" value="return" onchange="handleModeChange()">
                                <label for="modeReturn">Return</label>
                            </div>
                        </div>
                        <button type="button" class="btn-clear-v2" onclick="clearSaleItems()" title="Clear Order">
                            <i class="ph-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="customer-selector-v2">
                <div class="select-wrapper-v2">
                    <i class="ph-user-circle"></i>
                    <select name="customer_name" id="customerSelect" required onchange="handleCustomerChange()">
                        <option value="">Select Customer</option>
                        @if (customers != null)
                        {
                            foreach (var c in customers)
                            {
                                <option value="@c.name">@c.name</option>
                            }
                        }
                    </select>
                </div>
                <a href="/Customer/Create" title="Add New Customer" class="btn-add-customer">
                    <i class="ph-plus"></i>
                    <span>Add Customer</span>
                </a>
            </div>

            <div class="checkout-items-v2" id="saleItemsBody">
                <!-- Items populated by JS -->
            </div>

            <div id="emptyStateV2" class="empty-state-v2">
                <div class="empty-glow"></div>
                <i class="ph-shopping-cart-simple"></i>
                <p>Bag is empty</p>
            </div>

            <div class="checkout-footer-v2">
                <div class="price-summary-v2">
                    <div class="summary-line">
                        <span>Subtotal</span>
                        <span id="subtotalDisplay">$0.00</span>
                    </div>
                    <div class="summary-line" style="color: var(--success);">
                        <span>Discount</span>
                        <span id="discountDisplay">$0.00</span>
                    </div>
                    
                    <div id="stockAlert" class="alert-v2" style="display: none;">
                        <i class="ph-warning"></i> <span id="stockAlertMsg"></span>
                    </div>

                    <div class="grand-total-row">
                        <div class="total-label">Grand Total</div>
                        <div class="total-value" id="grandTotal">$0.00</div>
                    </div>
                </div>

                <div id="hiddenInputsContainer"></div>

                <button type="button" class="btn-pay-v2" onclick="openPaymentModal()">
                    <i class="ph-credit-card"></i>
                    Payment
                </button>

            </div>
        </form>
    </div>
</div>

<!-- Modern Web Payment Modal -->
<div class="modal-overlay" id="paymentModal">
    <div class="payment-card">
        <!-- Left Side: Payment Input -->
        <div class="payment-left">
            <h1 class="payment-title">Checkout</h1>
            <p class="payment-subtitle">Complete your transaction by selecting a payment method.</p>
            
            <div class="method-tabs">
                <div class="method-tab active" id="btnCash" onclick="setWebPaymentMethod('Cash')">
                    <i class="ph-money"></i> <span>Cash</span>
                </div>
                <div class="method-tab" id="btnCard" onclick="setWebPaymentMethod('Card')">
                    <i class="ph-credit-card"></i> <span>Card</span>
                </div>
                <div class="method-tab" id="btnTransfer" onclick="setWebPaymentMethod('Transfer')">
                    <i class="ph-bank"></i> <span>Bank</span>
                </div>
                <div class="method-tab" id="btnCredit" onclick="setWebPaymentMethod('Credit')">
                    <i class="ph-user-focus"></i> <span>Credit</span>
                </div>
            </div>

            <div class="web-input-group">
                <label>Amount Tendered</label>
                <input type="number" id="webTendered" class="web-input" placeholder="0.00" oninput="calculateWebChange()" step="0.01">
                
                <div class="quick-pills">
                    <div class="quick-pill" onclick="addWebAmount(10)">+ $10</div>
                    <div class="quick-pill" onclick="addWebAmount(20)">+ $20</div>
                    <div class="quick-pill" onclick="addWebAmount(50)">+ $50</div>
                    <div class="quick-pill" onclick="addWebAmount(100)">+ $100</div>
                    <div class="quick-pill" onclick="matchWebAmount()">Match Total</div>
                </div>
            </div>

            <div class="web-input-group">
                <label>Reference / Note</label>
                <input type="text" name="notes" class="web-input" placeholder="Transaction notes (optional)">
            </div>
        </div>

        <!-- Right Side: Summary & Confirm -->
        <div class="payment-right">
            <div class="summary-box-web">
                <div class="summary-web-line">
                    <span style="color: var(--text-muted); font-weight: 600;">Total Amount Due</span>
                    <span id="webModalTotal" style="font-weight: 700;">$0.00</span>
                </div>
                <div class="summary-web-line" style="margin-top: 8px;">
                    <span style="color: var(--text-muted); font-weight: 600;">Total Tendered</span>
                    <span id="webModalTendered" style="font-weight: 700;">$0.00</span>
                </div>
                
                <div class="summary-web-line grand">
                    <span>Change Due</span>
                    <span id="webModalChange">$0.00</span>
                </div>
            </div>

            <div style="margin-top: auto;">
                <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-bottom: 24px; line-height: 1.5;">
                    By completing this order, you agree to generate an official invoice and update stock levels.
                </p>
                
                <div style="display: flex; gap: 16px;">
                    <button type="button" class="btn-confirm-web" style="background: var(--surface); color: var(--text-muted); border: 1px solid var(--border); flex: 1;" onclick="closePaymentModal()">Cancel</button>
                    <button type="button" class="btn-confirm-web" style="flex: 2; background: var(--primary); color: white;" onclick="submitSaleForm()">
                        Complete Order <i class="ph-check-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Item Modal -->
<div class="modal-overlay" id="customItemModal">
    <div class="payment-card" style="max-width: 500px; width: 90%; align-items: stretch; flex-direction: column;">
        <div style="padding: 32px;">
            <h2 style="margin: 0 0 24px 0; color: var(--text-main); font-size: 1.5rem;">Add Custom Item</h2>
            
            <div class="web-input-group">
                <label>Item Name / Description</label>
                <input type="text" id="customName" class="web-input" placeholder="e.g. Delivery Charge">
            </div>

            <div class="web-input-group">
                <label>Price</label>
                <input type="number" id="customPrice" class="web-input" placeholder="0.00" step="0.01">
            </div>

            <div style="display: flex; gap: 16px; margin-top: 32px;">
                <button type="button" class="btn-confirm-web" style="background: var(--surface); color: var(--text-muted); border: 1px solid var(--border); flex: 1;" onclick="closeCustomItemModal()">Cancel</button>
                <button type="button" class="btn-confirm-web" style="flex: 2; background: var(--primary); color: white;" onclick="addCustomItem()">
                    Add to Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal-overlay" id="customerModal">
    <div class="payment-card" style="max-width: 900px; width: 95%; align-items: stretch; flex-direction: column; overflow-y: auto; max-height: 90vh;">
        <div class="dashboard-panel" style="margin: 0; border: none; box-shadow: none;">
            <div class="page-header" style="padding: 24px 32px 0 32px;">
                <h1 class="page-title-large">Add New Customer</h1>
                <button type="button" class="btn-secondary" onclick="closeCustomerModal()">
                    <i class="ph-arrow-left"></i> Back to POS
                </button>
            </div>

            <div class="form-wrapper form-layout-left-wide" style="padding: 32px;">
                <!-- Combined Information -->
                <div class="form-section">
                    <div class="form-section-header">
                        <h3 class="form-section-title">
                            <i class="ph-users form-icon-primary"></i>
                            Customer Information
                        </h3>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" id="newCustName" class="form-control" placeholder="Enter customer's full name" required />
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Contact Number</label>
                            <input type="text" id="newCustContact" class="form-control" placeholder="Enter contact number" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="newCustEmail" class="form-control" placeholder="Enter email address" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="newCustAddress" class="form-control" rows="3" placeholder="Enter physical address"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="newCustStatus" class="form-control">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions-sticky" style="position: static; border-top: none; padding-top: 0;">
                    <button type="button" class="btn-secondary" onclick="closeCustomerModal()">
                        Cancel
                    </button>
                    <button type="button" class="btn-primary" onclick="saveCustomerAjax()">
                        <i class="ph-check"></i>
                        Save Customer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global State
    let saleItems = [];
    let currentTotal = 0;
    let searchMode = 'barcode'; 

    // Utility
    const format = (v) => (v < 0 ? '-' : '') + '$' + Math.abs(v).toLocaleString(undefined, { minimumFractionDigits: 2 });

    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    function reloadPage() {
        if (saleItems.length > 0) {
            if (confirm("Cart contains items. Reload and lose changes?")) {
                window.location.reload();
            }
        } else {
            window.location.reload();
        }
    }

    // Modal Controls
    function openCustomItemModal() {
        document.getElementById('customName').value = '';
        document.getElementById('customPrice').value = '';
        document.getElementById('customItemModal').classList.add('show');
        document.getElementById('customName').focus();
    }

    function closeCustomItemModal() {
        document.getElementById('customItemModal').classList.remove('show');
    }

    function triggerCustomerModalV2(e) {
        if (e) e.preventDefault();
        document.getElementById('newCustName').value = '';
        document.getElementById('newCustContact').value = '';
        document.getElementById('newCustEmail').value = '';
        document.getElementById('newCustAddress').value = '';
        document.getElementById('customerModal').classList.add('show');
        document.getElementById('newCustName').focus();
    }

    function closeCustomerModal() {
        document.getElementById('customerModal').classList.remove('show');
    }

    // Modal Actions
    function addCustomItem() {
        const name = document.getElementById('customName').value.trim();
        const price = parseFloat(document.getElementById('customPrice').value);

        if (!name) return alert("Please enter item name");
        if (isNaN(price) || price < 0) return alert("Please enter a valid price");

        addItemToSale(0, name, price, 0, null, null, 999999, null);
        closeCustomItemModal();
    }

    async function saveCustomerAjax() {
        const name = document.getElementById('newCustName').value.trim();
        const contact = document.getElementById('newCustContact').value.trim();
        const email = document.getElementById('newCustEmail').value.trim();
        const address = document.getElementById('newCustAddress').value.trim();
        const status = document.getElementById('newCustStatus').value;

        if (!name) return alert("Customer name is required.");

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const response = await fetch('/Customer/CreateAjax', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({ name, contact, email, address, status })
            });
            const data = await response.json();
            if (data.success) {
                const select = document.getElementById('customerSelect');
                const opt = document.createElement('option');
                opt.value = data.name;
                opt.text = data.name;
                opt.selected = true;
                select.add(opt);
                
                closeCustomerModal();
                handleCustomerChange();
            } else {
                alert("Error saving customer: " + (data.message || "Unknown error"));
            }
        } catch (err) {
            console.error(err);
            alert("An error occurred while saving the customer.");
        }
    }

    // Filtering & Searching
    function handleSearchModeChange() {
        searchMode = document.querySelector('input[name="searchMode"]:checked').value;
        const input = document.getElementById('prodSearch');
        input.placeholder = searchMode === 'name' ? "Search by product name..." : "Scan or enter barcode...";
        input.value = '';
        filterProducts();
        input.focus();
    }

    function filterProducts() {
        const query = document.getElementById('prodSearch').value.toLowerCase();
        const cards = document.querySelectorAll('.product-card-v2');

        cards.forEach(card => {
            const name = (card.getAttribute('data-name') || card.dataset.searchName || "").toLowerCase();
            const barcode = (card.getAttribute('data-barcode') || card.dataset.barcode || "").toLowerCase();
            
            if (!query) {
                card.style.display = 'flex';
                return;
            }

            if (searchMode === 'barcode') {
                card.style.display = barcode.includes(query) ? 'flex' : 'none';
            } else {
                card.style.display = name.includes(query) ? 'flex' : 'none';
            }
        });
    }

    function filterByCategory(cat, btn) {
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        if (btn) btn.classList.add('active');
        else if (event && event.currentTarget) event.currentTarget.classList.add('active');
        
        const cards = document.querySelectorAll('.product-card-v2');
        cards.forEach(card => {
            const type = card.getAttribute('data-type') || card.dataset.type;
            if (cat === 'all') card.style.display = 'flex';
            else if (cat === 'Foods' && type === 'product') card.style.display = 'flex';
            else if (cat === 'Beverages' && type === 'service') card.style.display = 'flex';
            else card.style.display = 'none';
        });
    }

    // Cart Logic
    function addToSaleFromCard(card) {
        const id = card.dataset.id;
        const name = card.dataset.name;
        const price = parseFloat(card.dataset.price);
        const discount = parseFloat(card.dataset.discount);
        const expiry = card.dataset.expiry || null;
        const barcode = card.dataset.barcode || null;
        const maxStock = parseFloat(card.dataset.stock);
        const image = card.dataset.image || null;

        addItemToSale(id, name, price, discount, expiry, barcode, maxStock, image);
    }

    async function addItemToSale(id, name, price, discount, expiry, barcode, maxStock, image) {
        const mode = document.querySelector('input[name="transMode"]:checked').value;
        const isReturn = mode === 'return';
        const customerName = document.getElementById('customerSelect').value;

        if (isReturn) {
            if (!customerName) return showStockAlert("Please select a customer first.");
            const validation = await validateReturnEligibility(customerName, name);
            if (!validation.eligible) return showStockAlert(`Customer has no purchase history for ${name}.`);
            
            const existing = saleItems.find(i => i.prod_name_service === name);
            if ((existing && Math.abs(existing.qty - 1) > validation.purchasedQty) || (!existing && 1 > validation.purchasedQty)) {
                return showStockAlert(`Cannot return more than purchased.`);
            }
        }

        const qtyToAdd = isReturn ? -1 : 1;
        const existing = saleItems.find(i => i.prod_name_service === name);
        if (existing) {
            if (!isReturn && (existing.qty + qtyToAdd) > maxStock) return showStockAlert(`Only ${maxStock} available.`);
            existing.qty += qtyToAdd;
            if (existing.qty === 0) return removeItem(saleItems.indexOf(existing));
            existing.total_price = (existing.price * existing.qty) - (existing.discount * existing.qty);
        } else {
            if (!isReturn && qtyToAdd > maxStock) return showStockAlert(`Insufficient stock (${maxStock}).`);
            saleItems.push({
                prod_name_service: name,
                barcode: barcode || null,
                qty: qtyToAdd,
                price: price,
                discount: discount,
                expiry_date: expiry || null,
                maxStock: maxStock,
                image: image || null,
                total_price: (price * qtyToAdd) - (discount * qtyToAdd)
            });
        }
        renderSaleItems();
    }

    function renderSaleItems() {
        const body = document.getElementById('saleItemsBody');
        const empty = document.getElementById('emptyStateV2');
        const hiddenContainer = document.getElementById('hiddenInputsContainer');
        const subtotalSpan = document.getElementById('subtotalDisplay');
        const discountSpan = document.getElementById('discountDisplay');
        const grandTotalSpan = document.getElementById('grandTotal');
        const countDisplay = document.getElementById('itemCountDisplay');

        body.innerHTML = "";
        hiddenContainer.innerHTML = "";
        countDisplay.innerText = `${saleItems.length} item${saleItems.length !== 1 ? 's' : ''} selected`;

        if (saleItems.length === 0) {
            empty.style.display = "flex";
            body.style.display = "none";
            subtotalSpan.innerText = "$0.00";
            discountSpan.innerText = "-$0.00";
            document.getElementById('taxDisplay').innerText = "$0.00";
            grandTotalSpan.innerText = "$0.00";
            currentTotal = 0;
            return;
        }
        empty.style.display = "none";
        body.style.display = "flex";

        let totalSub = 0, totalDisc = 0, totalBase = 0;

        saleItems.forEach((item, index) => {
            const lineSub = item.price * item.qty;
            const lineDisc = item.discount * item.qty;
            const lineTotal = lineSub - lineDisc;

            totalSub += lineSub;
            totalDisc += lineDisc;
            totalBase += lineTotal;

            const div = document.createElement('div');
            div.className = "item-v2";
            div.innerHTML = `
                <div class="item-v2-img">
                    ${item.image ? `<img src="/product-images/${item.image}" />` : `<i class="ph-package" style="font-size:1.5rem; color:#cbd5e1;"></i>`}
                </div>
                <div class="item-v2-info">
                    <div class="title">${item.prod_name_service}</div>
                    <div class="price-sub">${format(lineTotal)}</div>
                </div>
                <div class="item-v2-controls">
                    <div class="qty-stepper">
                        <button type="button" onclick="decreaseQtyBtn(${index})">-</button>
                        <span>${item.qty < 0 ? '-' : ''}${Math.abs(item.qty)}</span>
                        <button type="button" onclick="increaseQty(${index})">+</button>
                    </div>
                </div>
                <i class="ph-trash btn-remove-item" onclick="removeItem(${index})"></i>
            `;
            body.appendChild(div);

            const prefix = `items[${index}]`;
            hiddenContainer.innerHTML += `
                <input type="hidden" name="${prefix}.prod_name_service" value="${item.prod_name_service}" />
                <input type="hidden" name="${prefix}.barcode" value="${item.barcode || ''}" />
                <input type="hidden" name="${prefix}.qty_unit_type" value="${item.qty}" />
                <input type="hidden" name="${prefix}.price" value="${item.price}" />
                <input type="hidden" name="${prefix}.discount" value="${item.discount}" />
                <input type="hidden" name="${prefix}.expiry_date" value="${item.expiry_date || ''}" />
                <input type="hidden" name="${prefix}.total_price" value="${lineTotal}" />
            `;
        });

        const taxAmount = totalBase * 0.0825;
        const finalTotal = totalBase + taxAmount;
        currentTotal = finalTotal;

        subtotalSpan.innerText = format(totalSub);
        discountSpan.innerText = "-" + format(totalDisc);
        document.getElementById('taxDisplay').innerText = format(taxAmount);
        grandTotalSpan.innerText = format(finalTotal);
    }

    async function increaseQty(index) {
        const item = saleItems[index];
        const mode = document.querySelector('input[name="transMode"]:checked').value;
        const isReturn = mode === 'return';

        if (isReturn) {
            const customerName = document.getElementById('customerSelect').value;
            const validation = await validateReturnEligibility(customerName, item.prod_name_service);
            if (Math.abs(item.qty - 1) > validation.purchasedQty) return showStockAlert("Max returnable reached.");
            item.qty--;
        } else {
            if (item.qty >= item.maxStock) return showStockAlert("Max stock reached.");
            item.qty++;
        }
        item.total_price = (item.price * item.qty) - (item.discount * item.qty);
        renderSaleItems();
    }

    function decreaseQtyBtn(index) {
        const item = saleItems[index];
        const isReturn = document.querySelector('input[name="transMode"]:checked').value === 'return';
        if (isReturn) item.qty++;
        else item.qty--;

        if (item.qty === 0) removeItem(index);
        else {
            item.total_price = (item.price * item.qty) - (item.discount * item.qty);
            renderSaleItems();
        }
    }

    function removeItem(index) {
        saleItems.splice(index, 1);
        renderSaleItems();
    }

    function clearSaleItems() {
        if (saleItems.length > 0 && confirm("Clear current order?")) {
            saleItems = [];
            renderSaleItems();
        }
    }

    function showStockAlert(msg) {
        const el = document.getElementById('stockAlert');
        document.getElementById('stockAlertMsg').innerText = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 4000);
    }

    // Handlers
    async function handleModeChange() {
        const mode = document.querySelector('input[name="transMode"]:checked').value;
        const isReturn = mode === 'return';
        const customerName = document.getElementById('customerSelect').value;

        if (isReturn && customerName) {
            try {
                const res = await fetch(`/Sale/CheckAnyPurchaseHistory?customerName=${encodeURIComponent(customerName)}`);
                const data = await res.json();
                if (!data.hasAnyHistory) {
                    showStockAlert("Customer has no active purchases.");
                    saleItems = [];
                }
            } catch (e) { console.error(e); }
        }

        saleItems.forEach(item => {
            const absQty = Math.abs(item.qty);
            item.qty = isReturn ? -absQty : absQty;
            item.total_price = (item.price * item.qty) - (item.discount * item.qty);
        });
        renderSaleItems();
    }

    async function handleCustomerChange() {
        const customerName = document.getElementById('customerSelect').value;
        const isReturn = document.querySelector('input[name="transMode"]:checked').value === 'return';

        if (isReturn && customerName) {
            try {
                const res = await fetch(`/Sale/CheckAnyPurchaseHistory?customerName=${encodeURIComponent(customerName)}`);
                const data = await res.json();
                if (!data.hasAnyHistory) {
                    showStockAlert("Customer has no active purchases.");
                    saleItems = [];
                    renderSaleItems();
                    return;
                }
            } catch (e) { console.error(e); }

            for (let i = saleItems.length - 1; i >= 0; i--) {
                const validation = await validateReturnEligibility(customerName, saleItems[i].prod_name_service);
                if (!validation.eligible) saleItems.splice(i, 1);
                else if (Math.abs(saleItems[i].qty) > validation.purchasedQty) {
                    saleItems[i].qty = -validation.purchasedQty;
                }
            }
            renderSaleItems();
        }
    }

    async function validateReturnEligibility(customerName, productName) {
        if (!customerName || !productName) return { eligible: true, purchasedQty: 0 };
        try {
            const response = await fetch(`/Sale/CheckPurchaseHistory?customerName=${encodeURIComponent(customerName)}&productName=${encodeURIComponent(productName)}`);
            const data = await response.json();
            return { eligible: data.hasPurchased, purchasedQty: data.purchasedQty || 0 };
        } catch (e) { return { eligible: true, purchasedQty: 999999 }; }
    }

    // Payment Modal
    function openPaymentModal() {
        if (saleItems.length === 0) return alert("Cart is empty.");
        document.getElementById('webModalTotal').innerText = format(currentTotal);
        document.getElementById('webTendered').value = "";
        calculateWebChange();
        document.getElementById('paymentModal').classList.add('show');
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').classList.remove('show');
    }

    function setWebPaymentMethod(method) {
        document.getElementById('hiddenPaymentMethod').value = method;
        document.getElementById('hiddenStatus').value = (method === 'Credit') ? 'Pending' : 'Paid';
        document.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
        if (event && event.currentTarget) event.currentTarget.classList.add('active');
    }

    function calculateWebChange() {
        const tendered = parseFloat(document.getElementById('webTendered').value) || 0;
        const change = tendered - currentTotal;
        document.getElementById('webModalTendered').innerText = format(tendered);
        document.getElementById('webModalChange').innerText = format(change);
    }

    function addWebAmount(amt) {
        const el = document.getElementById('webTendered');
        el.value = (parseFloat(el.value || 0) + amt).toFixed(2);
        calculateWebChange();
    }

    function matchWebAmount() {
        document.getElementById('webTendered').value = Math.max(0, currentTotal).toFixed(2);
        calculateWebChange();
    }

    function submitSaleForm() {
        const cust = document.getElementById('customerSelect').value;
        if (!cust) return alert("Please select a customer.");
        document.getElementById('saleForm').submit();
    }
</script>
