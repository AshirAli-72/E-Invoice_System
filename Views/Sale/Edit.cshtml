@model E_Invoice_system.Models.Sale

<div class="card" style="max-width: 1000px; margin: 2rem auto; box-shadow: var(--shadow); border: none; border-radius: 12px;">
   
    <form asp-action="Edit" method="post" style="padding: 2rem;">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="id" />
        <input type="hidden" asp-for="date" />

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <!-- Customer Info -->
            <div>
                <label asp-for="buyer_name" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;">Buyer Name</label>
                <input asp-for="buyer_name" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); outline: none;" placeholder="Enter buyer name" />
                <span asp-validation-for="buyer_name" style="color: var(--primary); font-size: 0.75rem;"></span>
            </div>
            <div>
                <label asp-for="payment_method" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;">Payment Method</label>
                <select asp-for="payment_method" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); outline: none; background: white;" required>
                    <option value="">Select Payment Method</option>
                    <option value="Cash">Cash</option>
                    <option value="Card">Card</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Mobile Payment">Mobile Payment</option>
                </select>
                <span asp-validation-for="payment_method" style="color: var(--primary); font-size: 0.75rem;"></span>
            </div>
            <div>
                <label asp-for="status" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;">Status</label>
                <select asp-for="status" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); outline: none; background: white;" required>
                    <option value="">Select Status</option>
                    <option value="Paid<">Paid</option>
                    <option value="Pending">Pending</option>
                    <option value="Cancelled">Cancelled</option>
                    
                </select>
                <span asp-validation-for="status" style="color: var(--primary); font-size: 0.75rem;"></span>
            </div>
        </div>

        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
            <h3 style="font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="ph-package" style="color: var(--primary);"></i> Product Information
            </h3>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
                <div>
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;">Select Product / Service</label>
                    <select id="productSelect" class="form-control" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); outline: none; background: white;" required>
                        <option value="">Select a product...</option>
                        @foreach (var p in ViewBag.Products)
                        {
                            <option value="@p.prod_name_service" 
                                    data-price="@p.price" 
                                    data-discount="@p.discount"
                                    selected="@(p.prod_name_service == Model.prod_name_service ? "selected" : null)">
                                @p.prod_name_service - $@p.price
                            </option>
                        }
                    </select>
                    <input type="hidden" asp-for="prod_name_service" id="prod_name_service" />
                </div>
                <div>
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;">Quantity / Unit</label>
                    <input asp-for="qty_unit_type" id="quantityInput" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); outline: none;" placeholder="e.g. 5 or 5 Kg" required />
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem;">
                <div>
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;">Unit Price ($)</label>
                    <input asp-for="price" id="priceInput" type="number" step="0.01" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); outline: none;" required />
                </div>
                <div>
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;">Discount ($)</label>
                    <input asp-for="discount" id="discountInput" type="number" step="0.01" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); outline: none;" />
                </div>
                <div>
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;">Expiry Date</label>
                    <input asp-for="expiry_date" type="date" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); outline: none;" />
                </div>
            </div>
        </div>

        <!-- Summary & Totals -->
        <div style="background: var(--text); color: white; border-radius: 12px; padding: 1.5rem 2rem; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 0.85rem; opacity: 0.8;">Total Sale Amount</div>
                <div style="font-size: 0.75rem; opacity: 0.6;">(Price Ã— Qty) - Discount</div>
            </div>
            <div id="totalDisplay" style="font-size: 2rem; font-weight: 800; color: var(--primary-hover);">$@Model.total_price.ToString("N2")</div>
        </div>

        <div>
            <label asp-for="description" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;">Additional Notes</label>
            <textarea asp-for="description" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); outline: none; resize: vertical;" rows="3" placeholder="Enter any additional details about this sale..."></textarea>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 2.5rem;">
            <button type="submit" class="btn-primary" style="flex: 1; justify-content: center; padding: 1rem;">
                <i class="ph-floppy-disk"></i> Update Sale
            </button>
            <a asp-action="Index" class="btn-primary" style="flex: 0.5; justify-content: center; background: white; color: var(--text); border: 1px solid var(--border);">Cancel</a>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productSelect = document.getElementById('productSelect');
        const prodNameHidden = document.getElementById('prod_name_service');
        const quantityInput = document.getElementById('quantityInput');
        const priceInput = document.getElementById('priceInput');
        const discountInput = document.getElementById('discountInput');
        const totalDisplay = document.getElementById('totalDisplay');

        function calculateTotal() {
            // Parse quantity (handle strings like "5 Kg")
            const qtyStr = quantityInput.value.trim();
            const qtyNum = parseFloat(qtyStr.split(' ')[0]) || 0;
            
            const price = parseFloat(priceInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;

            const total = (price * qtyNum) - discount;
            totalDisplay.textContent = '$' + total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        productSelect.addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            if (selected.value) {
                prodNameHidden.value = selected.value;
                priceInput.value = selected.dataset.price || 0;
                discountInput.value = selected.dataset.discount || 0;
            } else {
                prodNameHidden.value = "";
                priceInput.value = 0;
                discountInput.value = 0;
            }
            calculateTotal();
        });

        [quantityInput, priceInput, discountInput].forEach(el => {
            el.addEventListener('input', calculateTotal);
        });

        // Initialize display
        calculateTotal();
    });
</script>

